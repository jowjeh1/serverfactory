SERVER FACTORY: Project Context & AI Instructions

ðŸ¤– INSTRUCTIONS FOR AI AGENTS

READ THIS FIRST.
This repository contains a "Server Factory" pipeline for automating Windows Server 2022 builds using HashiCorp Packer and Hyper-V.
Your goal is to maintain the integrity of the 4-Layer Architecture and strict Change Control protocols.

1. Project Architecture (The "4 Layers")

We do not build monolithic images. We build layered artifacts to ensure speed and modularity.

Layer 1 (Base): * Input: Raw ISO (ISO/WS2022.iso).

Output: Raw VHDX with OS installed.

Tool: Packer hyperv-iso.

Key File: 1-base.pkr.hcl.

Layer 2 (Patching):

Input: Layer 1 VHDX.

Action: Runs a 3-Pass Windows Update Cycle to ensure the image is fully patched.

Output: "Golden Image" (Sysprepped).

Key File: 2-patch.pkr.hcl, scripts/update.ps1.

Layer 3 (Factory):

Input: Golden Image.

Action: Installs Role Binaries (IIS, AD-DS, etc.) but DOES NOT configure them.

Mechanism: Seeds the target Hostname into the Registry (HKLM:\Software\ServerFactory) to survive Sysprep.

Output: Final VM Artifact imported into Hyper-V.

Key File: 3-deploy.pkr.hcl, scripts/deploy-config.ps1.

Layer 4 (Runtime):

Input: The live, booted VM from Layer 3.

Action: "Day 0" Configuration (Identity, IP, Domain Join, Security).

Tool: PowerShell Script (RuntimeWizard.ps1) runs on first login.

2. Critical Engineering Constraints (DO NOT BREAK)

A. Hostname Persistence

Problem: Sysprep wipes C:\ProgramData and standard config files.

Solution: We store the target hostname in registry key HKLM:\Software\ServerFactory\TargetName during Layer 3. Layer 4 reads this key to rename the computer.

B. DC Promotion Logic (Fragile)

Constraint: Promoting a Domain Controller requires a reboot.

Mechanism: RuntimeWizard.ps1 calls Install-ADDSForest.

Current State: We run this command directly (removed Start-Process wrappers) to allow the native Windows restart sequence to occur naturally. The script waits 300 seconds for the OS to kill the process during shutdown. Do not add explicit exit or Restart-Computer commands immediately after promotion, as this race condition breaks the promotion commit.

C. Network Configuration

Constraint: DC Promotion requires a Static IP/DNS before the promotion command runs.

Logic: The Configure-Network function is triggered only inside the Promote-DC block. Standard member servers default to DHCP.

D. Update Stability

Constraint: Windows Updates often fail if the service stops unexpectedly.

Logic: scripts/update.ps1 uses a retry loop (up to 3 attempts) and self-healing logic (restarting wuauserv) if scanning fails.

E. Portability

Constraint: The project must run from any folder.

Solution: All Packer templates use ${path.root}. The PowerShell wrapper (build.ps1) explicitly sets $PSScriptRoot as the working directory.

3. Directory Structure Map

/ (Root)
â”œâ”€â”€ packer.exe              # Local binary (required)
â”œâ”€â”€ *.pkr.hcl               # Packer Templates (Layers 1-3)
â”œâ”€â”€ Autounattend.xml        # Boot configuration for Layer 1
â”œâ”€â”€ Unattend.xml            # Sysprep answer file for Layer 3
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.ps1           # MASTER WRAPPER: Run this to start the build.
â”‚   â”œâ”€â”€ update.ps1          # Robust update logic.
â”‚   â”œâ”€â”€ deploy-config.ps1   # Layer 3 role injection.
â”‚   â””â”€â”€ RuntimeWizard.ps1   # Layer 4 "Day 0" logic (The brain).
â”‚
â””â”€â”€ tools/Oscdimg/          # Dependency for creating ISOs


4. Change Control Policy

Strict Validation Required.

Do not refactor working logic without explicit authorization.

If a bug is found, propose the fix first.

Always check RuntimeWizard.ps1 against the "Critical Constraints" above before modifying.

5. How to Run (Standard Operating Procedure)

Open PowerShell as Administrator.

Navigate to the project root.

Run .\scripts\build.ps1.

Follow the interactive menu to select Hostname and Role.

Wait for the VM to auto-import into Hyper-V.

Connect to the VM to watch the RuntimeWizard complete the setup.