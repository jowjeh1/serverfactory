SERVER FACTORY: Project Context & AI Instructions

ðŸ¤– INSTRUCTIONS FOR AI AGENTS

READ THIS FIRST.
This repository contains a "Server Factory" pipeline for automating Windows Server 2022 builds using HashiCorp Packer and Hyper-V.
Your goal is to maintain the integrity of the 4-Layer Architecture, the "Opt-In" configuration philosophy, and the strict Change Control protocols.

Project Architecture (The "4 Layers")

We do not build monolithic images. We build layered artifacts to ensure speed, modularity, and resilience.

Layer 1 (Base):

Input: Raw ISO (ISO/WS2022.iso).

Output: Raw VHDX with OS installed.

Tool: Packer hyperv-iso.

Key File: 1-base.pkr.hcl.

Layer 2 (Patching):

Input: Layer 1 VHDX.

Action: Runs a 3-Pass Windows Update Cycle to ensure the image is fully patched.

Output: "Golden Image" (Sysprepped).

Key File: 2-patch.pkr.hcl, scripts/update.ps1.

Layer 3 (Factory):

Input: Golden Image.

Action: Installs Role Binaries (IIS, AD-DS, Containers, etc.).

Critical Mechanism: Seeds BOTH the target Hostname AND the Server Role into the Registry (HKLM:\Software\ServerFactory) to survive Sysprep.

Output: Final VM Artifact imported into Hyper-V.

Key File: 3-deploy.pkr.hcl, scripts/deploy-config.ps1.

Layer 4 (Runtime):

Input: The live, booted VM from Layer 3.

Action: "Day 0" Configuration Engine (Identity, Network, Role Configuration, Security).

Mechanism: Runs once on first login via RunOnce registry key.

Tool: PowerShell Script (RuntimeWizard.ps1).

Critical Engineering Constraints (DO NOT BREAK)

A. Hostname & Role Persistence (The "Registry Intent" Pattern)

Problem: Sysprep /generalize wipes C:\ProgramData and often strips feature flags (specifically Containers/Hyper-V status).

Solution: We persist the "Intent" in the Registry during Layer 3.

Path: HKLM:\Software\ServerFactory

Keys: 'TargetName' and 'ServerRole'.

Layer 4 Logic: Always check Get-StoredRole (Registry) first. If the Registry says "ContainerHost" but the feature is missing, trigger Self-Healing (reinstall + reboot).

B. The "Opt-In" Hardening Rule

Constraint: The Runtime Wizard must NEVER automatically apply breaking changes (Firewalls, Disabling Protocols, AppLocker).

Pattern: Detect the Role -> PROMPT the User -> Apply only if [Y].

Example: "IIS Detected. Apply Security Hardening? [Y/N]".

C. DC Promotion Logic (Fragile)

Constraint: Promoting a DC requires a reboot and specific DNS settings.

Logic:

Set IP/DNS (Pre-Flight).

Install-ADDSForest (No Start-Process wrapper).

Allow the command to reboot the server naturally.

Self-Reference: DCs must enforce DNS = 127.0.0.1.

D. Dynamic Networking

Layer 3: build.ps1 dynamically scans for Hyper-V switches and passes the selection to Packer.

Layer 4: RuntimeWizard.ps1 performs DNS Pre-Flight checks before Domain Joining to prevent timeout errors.

Runtime Modules (Layer 4 Capabilities)

The RuntimeWizard.ps1 engine is modular. It supports the following roles based on Registry Intent:

Web (IIS): Configures AppPools, Prompts for Hardening (Headers), Prompts for Self-Signed SSL.

ContainerHost: Robust detection (Registry/Service/Feature). Prompts for NAT Network creation and Docker storage. Includes Self-Healing if Sysprep stripped the feature.

FileServer: Prompts for FSRM Ransomware Screens (if FSRM installed) and SMB Hardening (Disable SMBv1).

RDS: Prompts for Session Timeouts (Idle/Disconnect) and Security Layer (NLA/SSL).

DC: Prompts for Forest Mode and Static IP.

Directory Structure Map

/ (Root)
â”œâ”€â”€ packer.exe              # Local binary
â”œâ”€â”€ *.pkr.hcl               # Packer Templates (Layers 1-3)
â”œâ”€â”€ Autounattend.xml        # Boot config (WinRM enabled, Firewall enabled)
â”œâ”€â”€ Unattend.xml            # Sysprep answer file
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.ps1           # MASTER WRAPPER: Handles inputs (CPU/RAM/Switch) and runs Packer.
â”‚   â”œâ”€â”€ update.ps1          # Robust update logic (3-Pass).
â”‚   â”œâ”€â”€ deploy-config.ps1   # Layer 3: Installs Binaries & Seeds Registry.
â”‚   â””â”€â”€ RuntimeWizard.ps1   # Layer 4: The Configuration Engine.
â”‚
â””â”€â”€ tools/Oscdimg/          # Dependency for creating ISOs

Standard Operating Procedure

Open PowerShell as Administrator.

Run .\scripts\build.ps1.

Select Hardware: Choose vCPU (2,4,8,12) and RAM (2GB-16GB).

Select Network: Script detects Hyper-V switches; choose the target.

Select Role: (Web, DC, File, RDS, Container, Mgmt).

Build: Wait for Packer to create the VM and import it.

Runtime: Connect to the VM console. The Wizard runs automatically. Follow the interactive prompts.