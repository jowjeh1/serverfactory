SERVER FACTORY: Project Context & AI Instructions

ðŸ¤– INSTRUCTIONS FOR AI AGENTS

READ THIS FIRST.
This repository contains a "Server Factory" pipeline for automating Windows Server 2022 builds using HashiCorp Packer and Hyper-V.
Your goal is to maintain the integrity of the 4-Layer Architecture, the "Opt-In" configuration philosophy, and the strict Change Control protocols.

Project Architecture (The "4 Layers")

We do not build monolithic images. We build layered artifacts to ensure speed, modularity, and resilience.

Layer 1 (Base):

Input: Raw ISO (ISO/WS2022.iso).

Output: Raw VHDX with OS installed.

Tool: Packer hyperv-iso (Self-contained template).

Key File: 1-base.pkr.hcl.

Layer 2 (Patching):

Input: Layer 1 VHDX.

Action: Runs a 3-Pass Windows Update Cycle to ensure the image is fully patched.

Output: "Golden Image" (Sysprepped).

Key File: 2-patch.pkr.hcl, scripts/update.ps1.

Layer 3 (Factory):

Input: Golden Image.

Action: Installs Role Binaries (IIS, AD-DS, Containers, etc.).

Critical Mechanism: Seeds BOTH the target Hostname AND the Server Role into the Registry (HKLM:\Software\ServerFactory) to survive Sysprep.

Output: Final VM Artifact imported into Hyper-V.

Key File: 3-deploy.pkr.hcl, scripts/deploy-config.ps1.

Layer 4 (Runtime):

Input: The live, booted VM from Layer 3.

Action: "Day 0" Configuration Engine (Identity, Network, Role Configuration, Security).

Mechanism: Runs once on first login via RunOnce registry key.

Tool: PowerShell Script (RuntimeWizard.ps1).

Critical Engineering Constraints (DO NOT BREAK)

A. Master Build Wrapper (build.ps1)

The scripts/build.ps1 script is the SINGLE entry point.

It handles PATH management (injecting tools\Oscdimg for Layer 1).

It provides a menu to select Layer 1, 2, or 3.

It dynamically scans Hyper-V switches for Layer 3.

B. Hostname & Role Persistence (The "Registry Intent" Pattern)

Problem: Sysprep /generalize wipes C:\ProgramData and often strips feature flags (specifically Containers/Hyper-V status).

Solution: We persist the "Intent" in the Registry during Layer 3.

Path: HKLM:\Software\ServerFactory

Keys: 'TargetName' and 'ServerRole'.

Layer 4 Logic: Always check Get-StoredRole (Registry) first.

Self-Healing: If Registry says "ContainerHost" but feature is missing, reinstall + reboot.

Hardware Validation: If hardware doesn't support Nested Virtualization, fail gracefully (do not reboot loop).

C. The "Opt-In" Hardening Rule

Constraint: The Runtime Wizard must NEVER automatically apply breaking changes (Firewalls, Disabling Protocols, AppLocker).

Pattern: Detect the Role -> PROMPT the User -> Apply only if [Y].

D. Packer Template Independence

Each .pkr.hcl file (1-base, 2-patch, 3-deploy) is self-contained.

They each contain their own required_plugins block.

Do NOT run packer init . (root) as this causes duplicate plugin errors. Initialize/Build specific files or use the wrapper.

Runtime Modules (Layer 4 Capabilities)

The RuntimeWizard.ps1 engine is modular (Engine v3.7+).

Web (IIS): Configures AppPools, Prompts for Hardening, Prompts for Self-Signed SSL.

ContainerHost: Checks Registry Intent. Validates CPU virtualization support. Prompts for NAT Network and Docker storage.

FileServer: Prompts for FSRM Ransomware Screens and SMB Hardening.

RDS: Prompts for Session Timeouts and Security Layer.

DC: Prompts for Forest Mode and Static IP.

Directory Structure Map

/ (Root)
â”œâ”€â”€ packer.exe              # Local binary
â”œâ”€â”€ 1-base.pkr.hcl          # Layer 1 Template (Base OS)
â”œâ”€â”€ 2-patch.pkr.hcl         # Layer 2 Template (Patching)
â”œâ”€â”€ 3-deploy.pkr.hcl        # Layer 3 Template (Deployment)
â”œâ”€â”€ Autounattend.xml        # Boot config
â”œâ”€â”€ Unattend.xml            # Sysprep answer file
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.ps1           # MASTER WRAPPER: Handles Layer 1/2/3 selection & environment.
â”‚   â”œâ”€â”€ update.ps1          # Robust update logic.
â”‚   â”œâ”€â”€ deploy-config.ps1   # Layer 3: Installs Binaries & Seeds Registry.
â”‚   â””â”€â”€ RuntimeWizard.ps1   # Layer 4: The Configuration Engine.
â”‚
â””â”€â”€ tools/Oscdimg/          # Required for Layer 1 ISO creation

Standard Operating Procedure

Open PowerShell as Administrator.

Run .\scripts\build.ps1.

Select Layer:

[1] Base Build (ISO -> VHDX)

[2] Patching (Update Cycle)

[3] Deployment (Create VM)

If Layer 3 selected:

Input Hostname, vCPU, RAM.

Select Hyper-V Switch.

Select Role.

Wait for Packer completion.

Connect to VM console for Runtime Wizard (Interactive).